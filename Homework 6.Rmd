---
title: "Homework 6, Amelia Grant-Alfieri, ag3911"
output: github_document
---

#Problem 1

Analyzing homicide data in the United States. 

##Tidy Data and Create New Variables
  * create a city_state variable (e.g. “Baltimore, MD”)
  * create a binary variable indicating whether the homicide is solved
  * omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race  
  * omit Tulsa, AL – this is a data entry mistake
  * modifiy victim_race to have categories white and non-white, with white as the reference category
  * be sure that victim_age is numeric.
```{r message=FALSE, output=FALSE}
library(tidyverse)
library(rvest)
library(httr)
library(tidyr)
library(stringr)
library(dplyr)
library(plyr)
library(stats)
getwd()

tidy = read_csv("./homicide-data.csv") %>%
  filter(city != "Dallas", city != "Phoenix", city != "Kansas City") %>%
  mutate(Tulsa_AL = (state == "AL" & city == "Tulsa")) %>%
  filter(Tulsa_AL == FALSE) %>%
  filter(victim_age != 102, victim_age != 101) %>%
  filter(victim_race != "Unknown" | victim_race == "NA") %>%
  filter(victim_age != "Unknown") %>%
  mutate(city_state = str_c(city, ", ", state),  #new var combines city and state
         resolved = as.numeric(disposition == "Closed by arrest")) %>% #new binary var for resolved
  mutate(victim_race = recode(victim_race,
    `White` = "white",
    `Black` = "non-white",
    `Hispanic` = "non-white",
    `Other` = "non-white",
    `Asian` = "non-white")) %>%
  mutate(victim_race = fct_relevel(victim_race, "white"))
```


##Logistic Regression Model for Baltimore, Maryland

  * For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs  unresolved as the outcome and victim age, sex and race (as just defined) as predictors. 
  * Save the output of glm as an R object
  * apply the  broom::tidy to this object

```{r output=FALSE}
baltimore = tidy %>%
  select(resolved, victim_age, victim_race, victim_sex)

balt_fit_log = 
  baltimore %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial())
```

Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.
```{r}
balt_fit_log %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  filter(term == "victim_racenon-white") %>%
  select(term, log_OR = estimate, std.error, OR) %>% 
  mutate(conf.high = log_OR + std.error,  
         conf.low = log_OR - std.error) %>%
  knitr::kable(digits = 3)
```
The log-transformed, adjusted OR is -0.52 with a 95% confidence interval of (-0.49, -0.549). 


##Logistic Regression for Each City 

Run glm for each of the cities in your dataset and extract the adjusted odds ratio (and CI) for solving homicides comparing non-white victims to white victims
Do this within a “tidy” pipeline, making use of purrr::map, list columns, and  unnest as necessary to create a dataframe with estimated ORs and CIs for each city.

```{r}
library(purrr)
library(tidyverse)
library(broom)

all_city_OR = tidy %>%
  mutate(output = map(.w = resolved, .x = victim_age , .y = victim_race , .z = victim_sex, ~ glm(.w ~ .x + .y + .z, data = ., family = binomial())))
##this function map isn't working for some reason... 

  broom::tidy() %>%
  mutate(OR = exp(estimate)) %>%
  filter(term == "victim_racenon-white") %>%
  select(term, log_OR = estimate, std.error, OR) %>%
  mutate(conf.high = log_OR + std.error, conf.low = log_OR - std.error)
  select(log_OR, conf.high, conf.low))) %>%    
  unnest()
```

##Plot Estimated Odds Ratios and Confidence Intervals for Each City 

Create a plot that shows the estimated ORs and CIs for each city. Organize cities according to estimated OR, and comment on the plot.

```{r}
library(ggplot2)

plot = all_city_OR %>%
  group_by(city_state) %>%
  #mutate(estimate = as.numeric(estimate)) %>%
  #arrange(city_state, desc(estimate)) %>%
  ggplot(aes(x = reorder(city_state, -log_OR), y = log_OR)) + geom_errorbar(aes(ymin = conf.low, ymax = conf.high, width = 0.2)) + geom_point() + labs(x = "Location", y = "log-transformed Odds Ratio", title = "The Odds of Solving Homicides for Non-White compared to White Victims by City, State") + theme(axis.text.x = element_text(angle = 90))
plot

```


#Problem 2

Understanding the effects of several variables on a child’s birthweight. 

##Load and Tidy Data

Load and clean the data for regression analysis (i.e. convert numeric to factor where appropriate, check for missing data, etc.).

```{r message=FALSE}
p2_tidy = read_csv("./birthweight.csv") %>%
  janitor::clean_names() %>%
  select(fincome, bwt, blength, gaweeks, bhead, babysex) %>%
  mutate(babysex = as.factor(babysex), 
         frace = as.factor(frace),
         gaweeks = as.numeric(gaweeks),
         mrace = as.factor(mrace)) %>%
  mutate(babysex = recode(babysex,`1` = "male",`2` = "female"), 
        
```

##Birthweight Regression Models

###Model #1
My proposed model uses father's income as a predictor of birthweight

Plot model residuals against fitted values (use  add_predictions and add_residuals)
```{r}
library(tidyverse)
library(modelr)
library(mgcv)

mod_1 = lm(bwt ~ fincome, data = p2_tidy) 
  broom::tidy() 

mod_1_plot = p2_tidy %>%
  modelr::add_residuals(mod_1) %>%
  modelr::add_predictions(mod_1) %>%
  ggplot(aes(x = fincome, y = bwt)) + geom_point() + geom_line(aes(y = resid), color = "red") + geom_line(aes(y = pred), color = "blue")
mod_1_plot

```


###Model #2
The second model using length at birth and gestational age as predictors (main effects only).

```{r}
mod_2 = lm(bwt ~ blength + gaweeks, data = p2_tidy) %>%
  broom::tidy() 
```


###Model #3
The third model using head circumference, length, sex, and all interactions (including the three-way interaction) between these. 

```{r}
mod_3 = lm(bwt ~ bhead + babysex + blength + bhead*babysex + bhead*blength + bhead*babysex*blength + blength*babysex, data = p2_tidy) %>%
  broom::tidy() 
```

p2_tidy %>%
  modelr::add_residuals(mod_3) %>%
  modelr::add_predictions(mod_3) %>%
  ggplot(aes(x = bwt, y = resid)) + geom_point() 



p2_tidy %>% 
  gather_predictions(lin_mod, nonlin_mod, wiggly_mod) %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = x, y = y)) + 
  geom_point() + 
  geom_line(aes(y = pred), color = "red") + 
  facet_wrap(~model)
```

###Compare Models #1 and #2

Compare in terms of the cross-validated prediction error (use crossv_mc and functions in purrr as appropriate).

```{r}
cv = 
  crossv_mc(p2_tidy, 100) %>%
  mutate(mod_1 = map(train, ~lm(bwt ~ fincome, data = p2_tidy) ,
         mod_2 = map(train, ~lm(bwt ~ blength + gaweeks, data = p2_tidy),
  mutate(rmse_mod_1 = map2_dbl(mod_1, test, ~rmse(model = .x, data = .y)),
         rmse_mod_2 = map2_dbl(mod_2, test, ~rmse(model = .x, data = .y))) 

cv %>%
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()


```

###Compare Models #1 and #3

Compare in terms of the cross-validated prediction error (use crossv_mc and functions in purrr as appropriate).

```{r}
cv = 
  crossv_mc(p2_tidy, 100) %>%
  mutate(mod_1 = map(train, ~lm(bwt ~ fincome, data = p2_tidy) ,
         mod_3 = map(train, ~lm(bwt ~ bhead + babysex + blength + bhead*babysex + bhead*blength + bhead*babysex*blength + blength*babysex, data = p2_tidy))) %>% 
  mutate(rmse_mod_1 = map2_dbl(mod_1, test, ~rmse(model = .x, data = .y)),
         rmse_mod_3 = map2_dbl(mod_3, test, ~rmse(model = .x, data = .y)))

cv %>%
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()

```

